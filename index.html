<!DOCTYPE html>
<html lang="ja">

<head>
  <title>Regions of Japan Map / 日本の地域</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link media="all" rel="stylesheet" href="./styles.css" />
  <link rel="shortcut icon" href="./favicon.ico">
  <script type="text/javascript" src="./regions.js"></script>
  <script type="text/javascript" src="./colors.js"></script>
  <script type="text/javascript" src="./utils.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js">
  </script>
  <script type="text/javascript">
    google.charts.load('current', { 'packages': ['geochart'], 'mapsApiKey': 'AIzaSyDWQEGh9S63LVWJOVzUX9lZqlTDWMe1nvk' });
    google.charts.setOnLoadCallback(drawRegionsMap);
    google.charts.setOnLoadCallback(drawCities);

    function createSvgPatterns() {

      const patterns = document.getElementById('patterns');

      patterns.innerHTML = document.getElementById('patterns_simple').contentDocument.querySelector('svg').innerHTML;
    }

    function parseData(jsonData) {
      const dataArray = [['Prefecture', 'Index']];

      jsonData.forEach((region, index) => {
        region.prefectures.forEach(prefecture => {
          dataArray.push([replaceSpecialCharactersWithAscii(prefecture.name.en), index]);
        });
      });

      return dataArray;
    }

    function parseDataForCities(jsonData) {
      const dataArray = [['City', 'isCapital']];

      jsonData.forEach((region, index) => {
        region.cities.forEach(city => {
          dataArray.push([replaceSpecialCharactersWithAscii(city.ja), city.capital ? 1 : 2]);
        });
      });

      return dataArray;
    }

    function populateLegend(regionsColors) {
      const legend = document.getElementById('legend');

      legend.innerHTML = `
        <h3>
          <div class="furigana-text">
            <span class="furigana">に ほん <span></span> ち いき</span>
            <span class="text">日本の地域</span>
          </div>
        </h3>
      `;

      regions.forEach((region, index) => {
        legend.innerHTML += (`
          <div class="legend-item">
            <div class="legend-color" style="background: ${regionsColors[index].color}"></div>
            <div class="legend-pattern">
              <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                <rect width="512" height="512" fill="url(#${regionsColors[index].pattern})" />
              </svg>
            </div>
            <div class="legend-ja">${region.name.ja}</div>
            <div class="legend-en">${region.name.en}</div>
          </div>
        `);
      });

      document.getElementById("colorRadio").onchange = (e) => handleFillmode(e.target.value, regionsColors);
      document.getElementById("patternRadio").onchange = (e) => handleFillmode(e.target.value, regionsColors);
    }

    function drawRegionsMap() {
      createSvgPatterns(colors);

      const data = google.visualization.arrayToDataTable(parseData(regions));

      const regionsColors = colors.splice(0, 8);

      const options = {
        region: 'JP',
        displayMode: 'regions',
        resolution: 'provinces',
        legend: 'none',
        colorAxis: { colors: regionsColors.map(item => item.color) },
        tooltip: {
          trigger: 'none'
        }
      };

      const chart = new google.visualization.GeoChart(document.getElementById('regions'));
      chart.draw(data, options);

      setTimeout(() => {
        populateLegend(regionsColors);
      }, 1000);
    }

    function drawCities() {

      const data = google.visualization.arrayToDataTable(parseDataForCities(regions));

      const options = {
        region: 'JP',
        displayMode: 'text',
        resolution: 'provinces',
        legend: 'none',
        backgroundColor: 'transparent',
        datalessRegionColor: 'transparent',
        backgroundColor: 'transparent',
        colorAxis: { colors: ['brown', 'black'] },
        sizeAxis: { minValue: 0, maxValue: 0 },
      };

      const chart = new google.visualization.GeoChart(document.getElementById('cities'));
      chart.draw(data, options);
    }

    function handleFillmode(mode, regionsColors) {
      document.body.className = `fillmode-${mode}`;

      regions.forEach((region, index) => {
        if (mode === 'color') {
          const maps = document.querySelectorAll(`#regions svg path[fill="url(#${regionsColors[index].pattern})"]`);
          maps.forEach((map) => {
            map.setAttribute('fill', `${regionsColors[index].color}`);
          })
        } else {
          const maps = document.querySelectorAll(`#regions svg path[fill="${regionsColors[index].color}"]`);
          maps.forEach((map) => {
            map.setAttribute('fill', `url(#${regionsColors[index].pattern})`);
          })
        }
      });
    }
  </script>
</head>

<body class="fillmode-color">
  <div id="maps">
    <div id="regions"></div>
    <div id="cities"></div>
  </div>
  <div id="legend"></div>
  <div id="fillmode">
    <form>
      <fieldset>
        <legend>Fill Mode</legend>
        <div class="item">
          <input type="radio" id="colorRadio" name="fillmode" value="color" checked />
          <label for="colorRadio">Color</label>
        </div>
        <div class="item">
          <input type="radio" id="patternRadio" name="fillmode" value="pattern" />
          <label for="patternRadio">Pattern</label>
        </div>
      </fieldset>
    </form>
  </div>
  <div class="shuriken">
    <div class="directions">
      <div class="direction direction-e">
        <div class="furigana-text">
          <span class="furigana">ひがし</span>
          <span class="text">東</span>
        </div>
      </div>
      <div class="direction direction-w">
        <div class="furigana-text">
          <span class="furigana">にし</span>
          <span class="text">西</span>
        </div>
      </div>
      <div class="direction direction-s">
        <div class="furigana-text">
          <span class="furigana">みなみ</span>
          <span class="text">南</span>
        </div>
      </div>
      <div class="direction direction-n">
        <div class="furigana-text">
          <span class="furigana">きた</span>
          <span class="text">北</span>
        </div>
      </div>
      <img src="./img/shuriken.svg" alt="Shuriken" />
    </div>
  </div>

  <svg x="0" y="0" width="100" height="100">
    <defs id="patterns"></defs>
  </svg>

  <object type="image/svg+xml" data="./img/patterns_simple.svg" id="patterns_simple"
    style="visibility: hidden;"></object>
</body>

</html>
